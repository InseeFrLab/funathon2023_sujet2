<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="fr" xml:lang="fr"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.361">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="keywords" content="RPG, prévisions, cultures">

<title>Prévisions</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./physio_era5.html" rel="next">
<link href="./app1.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "Pas de résultats",
    "search-matching-documents-text": "documents trouvés",
    "search-copy-link-title": "Copier le lien vers la recherche",
    "search-hide-matches-text": "Cacher les correspondances additionnelles",
    "search-more-match-text": "correspondance de plus dans ce document",
    "search-more-matches-text": "correspondances de plus dans ce document",
    "search-clear-button-title": "Effacer",
    "search-detached-cancel-button-title": "Annuler",
    "search-submit-button-title": "Envoyer",
    "search-label": "Recherche"
  }
}</script>
<style>html{ scroll-behavior: smooth; }</style>


</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Basculer la barre latérale" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./app2.html"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Cultures et prévisions climatiques</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Basculer la barre latérale" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Funathon 2023 - Sujet 2</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/InseeFrLab/funathon2023_sujet2/tree/main/website/" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <a href="./Funathon-2023---Sujet-2.pdf" title="Download PDF" class="quarto-navigation-tool px-1" aria-label="Download PDF"><i class="bi bi-file-pdf"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Recherche"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Contexte et description du sujet</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./app0.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Utilisation de PostgreSQL</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./app1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Première manipulation du RPG</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./app2.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Cultures et prévisions climatiques</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./physio_era5.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Évolution de la date théorique de récolte</span></span></a>
  </div>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Références</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table des matières</h2>
   
  <ul>
  <li><a href="#données" id="toc-données" class="nav-link active" data-scroll-target="#données"><span class="header-section-number">3.1</span> Données</a></li>
  <li><a href="#visualisations" id="toc-visualisations" class="nav-link" data-scroll-target="#visualisations"><span class="header-section-number">3.2</span> Visualisations</a></li>
  <li><a href="#requêtes-postgresql" id="toc-requêtes-postgresql" class="nav-link" data-scroll-target="#requêtes-postgresql"><span class="header-section-number">3.3</span> Requêtes PostgreSQL</a></li>
  <li><a href="#appariement-spatial-entre-données-drias-et-rpg" id="toc-appariement-spatial-entre-données-drias-et-rpg" class="nav-link" data-scroll-target="#appariement-spatial-entre-données-drias-et-rpg"><span class="header-section-number">3.4</span> Appariement spatial entre données DRIAS et RPG</a></li>
  <li><a href="#calcul-dindicateurs-par-type-de-culture" id="toc-calcul-dindicateurs-par-type-de-culture" class="nav-link" data-scroll-target="#calcul-dindicateurs-par-type-de-culture"><span class="header-section-number">3.5</span> Calcul d’indicateurs par type de culture</a></li>
  <li><a href="#pour-aller-plus-loin" id="toc-pour-aller-plus-loin" class="nav-link" data-scroll-target="#pour-aller-plus-loin"><span class="header-section-number">3.6</span> Pour aller plus loin</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Cultures et prévisions climatiques</span></h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Montrer tout le code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Cacher tout le code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">Voir les sources</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>Le changement climatique aura des changements importants sur les cultures en France, en particulier à cause de la diminution des précipitations dans certaines régions au cours des années à venir. Dans cette application, on souhaite identifier les cultures avec le niveau de risque le plus élevé.</p>
<section id="données" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="données"><span class="header-section-number">3.1</span> Données</h2>
<ul>
<li><p>Le <a href="https://geoservices.ign.fr/rpg">RPG</a> recense les parcelles déclarées à la PAC par les agriculteurs, leurs informations graphiques et leur culture principale. Ces données sont mises à disposition dans une base de données PostgreSQL.</p></li>
<li><p>Le projet <a href="https://www.drias-climat.fr/">Drias</a> a pour vocation de mettre à disposition des projections climatiques réalisées dans les laboratoires français de modélisation du climat (IPSL, CERFACS, CNRM). En particulier, nous disposons de projections locales du modèle CNRM-CM5 / ALADIN63 / correction ADAMONT. Ces données sont aussi mises à disposition sur PostgreSQL.</p></li>
</ul>
</section>
<section id="visualisations" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="visualisations"><span class="header-section-number">3.2</span> Visualisations</h2>
<p>On initialise une nouvelle fois la connexion à PostgreSQL comme expliqué à la fin de l’application 0.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RPostgres)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(aws.s3)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(raster)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(janitor)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Pour avoir les noms de dates en français</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="fu">invisible</span>(<span class="fu">Sys.setlocale</span>(<span class="st">"LC_ALL"</span>, <span class="st">"fr_FR.UTF-8"</span>))</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">knitr.kable.NA =</span> <span class="st">""</span>)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>cnx <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(<span class="fu">Postgres</span>(),</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>                 <span class="at">user =</span> <span class="fu">Sys.getenv</span>(<span class="st">"USER_POSTGRESQL"</span>),</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>                 <span class="at">password =</span> <span class="fu">Sys.getenv</span>(<span class="st">"PASS_POSTGRESQL"</span>),</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>                 <span class="at">host =</span> <span class="fu">Sys.getenv</span>(<span class="st">"HOST_POSTGRESQL"</span>),</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>                 <span class="at">dbname =</span> <span class="st">"defaultdb"</span>,</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>                 <span class="at">port =</span> <span class="dv">5432</span>,</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>                 <span class="at">check_interrupts =</span> <span class="cn">TRUE</span>)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>On souhaite tout d’abord visualiser les données DRIAS. On peut passer par les données sauvegardées au format raster qui sont stockées dans l’espace de stockage du SSP Cloud. Ces données correspondent à des prévisions à horizon proche (2021-2050) dans un scénario sans réduction des gaz à effet de serre, la période de référence étant 1976-2005. Le code ci-dessous permet de récupérer les données.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>drias_raster <span class="ot">&lt;-</span> <span class="fu">s3read_using</span>(</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(f) <span class="fu">readAll</span>(<span class="fu">brick</span>(f)),</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">object =</span> <span class="st">"2023/sujet2/diffusion/resultats/drias.tif"</span>,</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">bucket =</span> <span class="st">"projet-funathon"</span>,</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">opts =</span> <span class="fu">list</span>(<span class="st">"region"</span> <span class="ot">=</span> <span class="st">""</span>))</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>drias_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(drias_raster, <span class="at">xy =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> tidyr<span class="sc">::</span><span class="fu">drop_na</span>()</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(drias_df) <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">"x"</span>,</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">"y"</span>,</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">"NORRRA"</span>,</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">"NORSTM6"</span>,</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  <span class="st">"NORSTM0"</span>,</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>  <span class="st">"NORSDA"</span>,</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>  <span class="st">"NORDATEVEG"</span>,</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>  <span class="st">"NORDATEDG"</span>,</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>  <span class="st">"NORDATEPG"</span>,</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ARRA"</span>,</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ASTM6"</span>,</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ASTM0"</span>,</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ASDA"</span>,</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ADATEVEG"</span>,</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ADATEDG"</span>,</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ADATEPG"</span>,</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ALTI"</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>drias_df <span class="sc">%&gt;%</span> <span class="fu">head</span>(<span class="dv">10</span>) <span class="sc">%&gt;%</span> <span class="fu">kable</span>()</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 5%">
<col style="width: 4%">
<col style="width: 5%">
<col style="width: 5%">
<col style="width: 5%">
<col style="width: 5%">
<col style="width: 6%">
<col style="width: 6%">
<col style="width: 6%">
<col style="width: 5%">
<col style="width: 5%">
<col style="width: 5%">
<col style="width: 6%">
<col style="width: 6%">
<col style="width: 6%">
<col style="width: 5%">
<col style="width: 6%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: right;">x</th>
<th style="text-align: right;">y</th>
<th style="text-align: right;">NORRRA</th>
<th style="text-align: right;">NORSTM6</th>
<th style="text-align: right;">NORSTM0</th>
<th style="text-align: right;">NORSDA</th>
<th style="text-align: right;">NORDATEVEG</th>
<th style="text-align: right;">NORDATEDG</th>
<th style="text-align: right;">NORDATEPG</th>
<th style="text-align: right;">ARRA</th>
<th style="text-align: right;">ASTM6</th>
<th style="text-align: right;">ASTM0</th>
<th style="text-align: right;">ASDA</th>
<th style="text-align: right;">ADATEVEG</th>
<th style="text-align: right;">ADATEDG</th>
<th style="text-align: right;">ADATEPG</th>
<th style="text-align: right;">ALTI</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">633222.7</td>
<td style="text-align: right;">7102519</td>
<td style="text-align: right;">456.2780</td>
<td style="text-align: right;">1922.019</td>
<td style="text-align: right;">3166.208</td>
<td style="text-align: right;">1.970000</td>
<td style="text-align: right;">37.00000</td>
<td style="text-align: right;">246.0152</td>
<td style="text-align: right;">155.0000</td>
<td style="text-align: right;">39.49532</td>
<td style="text-align: right;">186.3507</td>
<td style="text-align: right;">242.3591</td>
<td style="text-align: right;">0.1700000</td>
<td style="text-align: right;">-6.000000</td>
<td style="text-align: right;">-13.03036</td>
<td style="text-align: right;">9.924110</td>
<td style="text-align: right;">2.000000</td>
</tr>
<tr class="even">
<td style="text-align: right;">641222.7</td>
<td style="text-align: right;">7102519</td>
<td style="text-align: right;">443.9634</td>
<td style="text-align: right;">1991.784</td>
<td style="text-align: right;">3237.846</td>
<td style="text-align: right;">1.703987</td>
<td style="text-align: right;">37.00000</td>
<td style="text-align: right;">231.2215</td>
<td style="text-align: right;">156.9705</td>
<td style="text-align: right;">35.80390</td>
<td style="text-align: right;">182.8417</td>
<td style="text-align: right;">240.3598</td>
<td style="text-align: right;">0.1305907</td>
<td style="text-align: right;">-6.000000</td>
<td style="text-align: right;">-15.95570</td>
<td style="text-align: right;">1.132903</td>
<td style="text-align: right;">2.000000</td>
</tr>
<tr class="odd">
<td style="text-align: right;">649222.7</td>
<td style="text-align: right;">7102519</td>
<td style="text-align: right;">443.9969</td>
<td style="text-align: right;">1995.343</td>
<td style="text-align: right;">3242.508</td>
<td style="text-align: right;">1.867559</td>
<td style="text-align: right;">37.00000</td>
<td style="text-align: right;">227.0574</td>
<td style="text-align: right;">157.9856</td>
<td style="text-align: right;">31.55116</td>
<td style="text-align: right;">181.4101</td>
<td style="text-align: right;">241.3846</td>
<td style="text-align: right;">0.3665546</td>
<td style="text-align: right;">-6.000000</td>
<td style="text-align: right;">-21.91386</td>
<td style="text-align: right;">1.985644</td>
<td style="text-align: right;">1.014356</td>
</tr>
<tr class="even">
<td style="text-align: right;">657222.7</td>
<td style="text-align: right;">7102519</td>
<td style="text-align: right;">436.6389</td>
<td style="text-align: right;">2002.257</td>
<td style="text-align: right;">3246.031</td>
<td style="text-align: right;">2.067211</td>
<td style="text-align: right;">37.00000</td>
<td style="text-align: right;">232.9163</td>
<td style="text-align: right;">158.0000</td>
<td style="text-align: right;">24.69242</td>
<td style="text-align: right;">188.7246</td>
<td style="text-align: right;">250.9371</td>
<td style="text-align: right;">0.4686055</td>
<td style="text-align: right;">-6.000000</td>
<td style="text-align: right;">-18.05578</td>
<td style="text-align: right;">6.930274</td>
<td style="text-align: right;">2.521252</td>
</tr>
<tr class="odd">
<td style="text-align: right;">665222.7</td>
<td style="text-align: right;">7102519</td>
<td style="text-align: right;">435.9542</td>
<td style="text-align: right;">2000.975</td>
<td style="text-align: right;">3246.324</td>
<td style="text-align: right;">2.058347</td>
<td style="text-align: right;">37.00000</td>
<td style="text-align: right;">230.7862</td>
<td style="text-align: right;">158.4427</td>
<td style="text-align: right;">24.02779</td>
<td style="text-align: right;">186.6543</td>
<td style="text-align: right;">248.8595</td>
<td style="text-align: right;">0.4583470</td>
<td style="text-align: right;">-6.000000</td>
<td style="text-align: right;">-17.55724</td>
<td style="text-align: right;">3.799755</td>
<td style="text-align: right;">2.349262</td>
</tr>
<tr class="even">
<td style="text-align: right;">673222.7</td>
<td style="text-align: right;">7102519</td>
<td style="text-align: right;">435.9155</td>
<td style="text-align: right;">2000.556</td>
<td style="text-align: right;">3245.985</td>
<td style="text-align: right;">2.050125</td>
<td style="text-align: right;">37.00000</td>
<td style="text-align: right;">230.5039</td>
<td style="text-align: right;">158.4992</td>
<td style="text-align: right;">23.95599</td>
<td style="text-align: right;">186.3690</td>
<td style="text-align: right;">248.5641</td>
<td style="text-align: right;">0.4501251</td>
<td style="text-align: right;">-6.000000</td>
<td style="text-align: right;">-17.50078</td>
<td style="text-align: right;">3.503910</td>
<td style="text-align: right;">2.497654</td>
</tr>
<tr class="odd">
<td style="text-align: right;">609222.7</td>
<td style="text-align: right;">7094519</td>
<td style="text-align: right;">479.2000</td>
<td style="text-align: right;">1851.100</td>
<td style="text-align: right;">3046.770</td>
<td style="text-align: right;">1.700000</td>
<td style="text-align: right;">39.00000</td>
<td style="text-align: right;">242.0000</td>
<td style="text-align: right;">152.0000</td>
<td style="text-align: right;">52.62000</td>
<td style="text-align: right;">193.7900</td>
<td style="text-align: right;">246.7000</td>
<td style="text-align: right;">0.0300000</td>
<td style="text-align: right;">-8.000000</td>
<td style="text-align: right;">-21.00000</td>
<td style="text-align: right;">6.000000</td>
<td style="text-align: right;">66.000000</td>
</tr>
<tr class="even">
<td style="text-align: right;">617222.7</td>
<td style="text-align: right;">7094519</td>
<td style="text-align: right;">468.7802</td>
<td style="text-align: right;">1908.548</td>
<td style="text-align: right;">3134.198</td>
<td style="text-align: right;">1.729771</td>
<td style="text-align: right;">38.00763</td>
<td style="text-align: right;">244.9771</td>
<td style="text-align: right;">152.9924</td>
<td style="text-align: right;">51.21084</td>
<td style="text-align: right;">195.0900</td>
<td style="text-align: right;">248.3969</td>
<td style="text-align: right;">-0.0692365</td>
<td style="text-align: right;">-7.007635</td>
<td style="text-align: right;">-17.03054</td>
<td style="text-align: right;">6.000000</td>
<td style="text-align: right;">20.351189</td>
</tr>
<tr class="odd">
<td style="text-align: right;">625222.7</td>
<td style="text-align: right;">7094519</td>
<td style="text-align: right;">461.3004</td>
<td style="text-align: right;">1925.008</td>
<td style="text-align: right;">3168.732</td>
<td style="text-align: right;">1.968268</td>
<td style="text-align: right;">37.00722</td>
<td style="text-align: right;">246.9856</td>
<td style="text-align: right;">154.9856</td>
<td style="text-align: right;">45.71983</td>
<td style="text-align: right;">190.3150</td>
<td style="text-align: right;">242.9796</td>
<td style="text-align: right;">0.1682681</td>
<td style="text-align: right;">-6.007217</td>
<td style="text-align: right;">-15.01443</td>
<td style="text-align: right;">5.007217</td>
<td style="text-align: right;">1.642246</td>
</tr>
<tr class="even">
<td style="text-align: right;">633222.7</td>
<td style="text-align: right;">7094519</td>
<td style="text-align: right;">456.2343</td>
<td style="text-align: right;">1922.001</td>
<td style="text-align: right;">3166.199</td>
<td style="text-align: right;">1.970000</td>
<td style="text-align: right;">37.00000</td>
<td style="text-align: right;">246.0068</td>
<td style="text-align: right;">155.0000</td>
<td style="text-align: right;">39.44270</td>
<td style="text-align: right;">186.3171</td>
<td style="text-align: right;">242.3540</td>
<td style="text-align: right;">0.1700000</td>
<td style="text-align: right;">-6.000000</td>
<td style="text-align: right;">-13.01360</td>
<td style="text-align: right;">9.966008</td>
<td style="text-align: right;">1.996718</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Les variables disponibles dans les données DRIAS sont systématiquement calculées sur la période 2021-2050 (préfixe NOR), et en écart avec la période de référence (préfixe A) :</p>
<ul>
<li>RRA : cumul de précipitations d’avril à octobre (mm)</li>
<li>STM6 : somme de température base 6°C d’avril à octobre (°C)</li>
<li>STM0 : somme de température base 0°C d’octobre (année-1) à juillet (année) (°C)</li>
<li>SDA : nombre de jours d’été d’avril à juin (jour(s))</li>
<li>DATEVEG : date de reprise de végétation en jour julien (date)</li>
<li>DATEDG : Date de dernière gelée avec 1er juillet comme référence (date)</li>
<li>DATEPG : Date de première gelée avec 1er juillet comme référence (date)</li>
</ul>
<p>On souhaite visualiser la variable ARRA, qui correspond à la huitième couche du raster et correspond à l’écart de cumul de précipitations d’avril à octobre en mm. Pour faire cela, on pourra récupérer spécifiquement la couche désirée lors de l’utilisation de la fonction <a href="https://www.rdocumentation.org/packages/raster/versions/3.6-20/topics/raster"><code>raster::raster</code></a>. Pour la visualisation, on pourra utiliser <a href="https://www.rdocumentation.org/packages/raster/versions/3.6-20/topics/plot"><code>raster::plot</code></a>.</p>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
</div>
<div class="callout-body-container callout-body">
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Bande ARRA</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>drias_raster_arra <span class="ot">&lt;-</span> <span class="fu">s3read_using</span>(</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(f) <span class="fu">readAll</span>(<span class="fu">raster</span>(f, <span class="at">band =</span> <span class="dv">8</span>)),</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">object =</span> <span class="st">"2023/sujet2/diffusion/resultats/drias.tif"</span>,</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">bucket =</span> <span class="st">"projet-funathon"</span>,</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">opts =</span> <span class="fu">list</span>(<span class="st">"region"</span> <span class="ot">=</span> <span class="st">""</span>))</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Avec palette custom</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>palette <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"#1457ff"</span>, <span class="st">"#3c9aff"</span>, <span class="st">"#6dc4ff"</span>, <span class="st">"#a8e1ff"</span>, <span class="st">"#dff1fb"</span>, <span class="st">"#f8e9eb"</span>, <span class="st">"#fca8ab"</span>, <span class="st">"#f9575d"</span>, <span class="st">"#f2060b"</span>, <span class="st">"#a20102"</span>)</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>breaks <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">200</span>, <span class="sc">-</span><span class="dv">160</span>, <span class="sc">-</span><span class="dv">120</span>, <span class="sc">-</span><span class="dv">80</span>, <span class="sc">-</span><span class="dv">40</span>, <span class="sc">-</span><span class="dv">0</span>, <span class="dv">40</span>, <span class="dv">80</span>, <span class="dv">120</span>, <span class="dv">160</span>, <span class="dv">200</span>)</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>raster<span class="sc">::</span><span class="fu">plot</span>(<span class="at">x =</span> drias_raster_arra,</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>             <span class="at">col =</span> <span class="fu">rev</span>(palette),</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>             <span class="at">breaks =</span> breaks,</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>             <span class="at">main =</span> <span class="st">"Ecart de cumul de précipitations d'avril à octobre (mm)</span><span class="sc">\n</span><span class="st">entre 2021-2050 et 1976-2005"</span>)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="app2_files/figure-html/drias_vis_raster-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
</div>
</div>
<p>Sur la période 2021-2050, les précipitations vont augmenter presque partout, sauf dans le Sud-Ouest de la France.</p>
</section>
<section id="requêtes-postgresql" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="requêtes-postgresql"><span class="header-section-number">3.3</span> Requêtes PostgreSQL</h2>
<p>Les données DRIAS sont également stockées dans une base PostgreSQL qu’il est possible de requêter. La table <code>drias.previsions</code> contient une grille équivalente aux données raster précédemment utilisées. On souhaite obtenir la même visualisation que celle obtenue précédemment en requêtant la base de données. Pour ce faire, utiliser la fonction <code>sf::st_read</code> avec une requête sur la table <code>drias.previsions</code>. Pour la création de la carte, on peut utiliser le package <code>ggplot2</code> et sa fonction <a href="https://ggplot2.tidyverse.org/reference/ggsf.html"><code>geom_sf</code></a>.</p>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
</div>
<div class="callout-body-container callout-body">
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>query <span class="ot">&lt;-</span> <span class="st">"</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="st">SELECT *</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="st">FROM drias.previsions</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="st">"</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>drias_sf <span class="ot">&lt;-</span> <span class="fu">st_read</span>(cnx, <span class="at">query =</span> query)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> drias_sf, <span class="fu">aes</span>(<span class="at">fill =</span> arra), <span class="at">color =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">binned_scale</span>(<span class="at">aesthetics =</span> <span class="st">"fill"</span>, <span class="at">scale_name =</span> <span class="st">"custom"</span>, </span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>               <span class="at">palette =</span> ggplot2<span class="sc">:::</span><span class="fu">binned_pal</span>(scales<span class="sc">::</span><span class="fu">manual_pal</span>(<span class="at">values =</span> <span class="fu">rev</span>(palette)[<span class="sc">-</span><span class="dv">1</span>])),</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>               <span class="at">guide =</span> <span class="st">"bins"</span>,</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>               <span class="at">breaks =</span> breaks)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="app2_files/figure-html/drias_vis_postgresql-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
</div>
</div>
</section>
<section id="appariement-spatial-entre-données-drias-et-rpg" class="level2" data-number="3.4">
<h2 data-number="3.4" class="anchored" data-anchor-id="appariement-spatial-entre-données-drias-et-rpg"><span class="header-section-number">3.4</span> Appariement spatial entre données DRIAS et RPG</h2>
<p>On aimerait associer chaque culture à une évolution en terme de cumul de précipitation. Pour ceci il faut tout d’abord récupérer pour chaque culture la surface des parcelles existantes dans chaque carreau de la grille DRIAS. Pour ceci on peut procéder à un appariement spatial des tables <code>drias.previsions</code> et <code>rpg.parcelles</code> de la base de données. On pourra s’aider de <a href="https://postgis.net/workshops/postgis-intro/joins.html">cette page</a> de documentation, et utiliser <a href="https://postgis.net/docs/ST_Intersects.html"><code>ST_Intersects</code></a>.</p>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
</div>
<div class="callout-body-container callout-body">
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># On récupère par carreau de la grille DRIAS la surface pour chaque type de culture</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>query <span class="ot">&lt;-</span> <span class="st">"</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="st">SELECT B.point, code_cultu, Sum(surf_parc) AS surface, B.arra</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="st">FROM rpg.parcelles AS A</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="st">JOIN drias.previsions AS B</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="st">ON ST_Intersects(A.geom , B.geometry)</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="st">GROUP BY B.point, B.arra, code_cultu</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="st">"</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">dbSendQuery</span>(cnx, query)</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>arra_df <span class="ot">&lt;-</span> <span class="fu">dbFetch</span>(res)</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>arra_df <span class="sc">%&gt;%</span> <span class="fu">head</span>(<span class="dv">10</span>) <span class="sc">%&gt;%</span> <span class="fu">kable</span>()</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">point</th>
<th style="text-align: left;">code_cultu</th>
<th style="text-align: right;">surface</th>
<th style="text-align: right;">arra</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">5343</td>
<td style="text-align: left;">CZH</td>
<td style="text-align: right;">78.79</td>
<td style="text-align: right;">10.30</td>
</tr>
<tr class="even">
<td style="text-align: right;">4803</td>
<td style="text-align: left;">BTH</td>
<td style="text-align: right;">18.06</td>
<td style="text-align: right;">23.71</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3903</td>
<td style="text-align: left;">BTA</td>
<td style="text-align: right;">25.21</td>
<td style="text-align: right;">-36.38</td>
</tr>
<tr class="even">
<td style="text-align: right;">3498</td>
<td style="text-align: left;">VRG</td>
<td style="text-align: right;">10.59</td>
<td style="text-align: right;">0.66</td>
</tr>
<tr class="odd">
<td style="text-align: right;">5078</td>
<td style="text-align: left;">VRN</td>
<td style="text-align: right;">0.65</td>
<td style="text-align: right;">12.48</td>
</tr>
<tr class="even">
<td style="text-align: right;">4939</td>
<td style="text-align: left;">ORH</td>
<td style="text-align: right;">186.01</td>
<td style="text-align: right;">10.59</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3624</td>
<td style="text-align: left;">TTH</td>
<td style="text-align: right;">90.12</td>
<td style="text-align: right;">-13.35</td>
</tr>
<tr class="even">
<td style="text-align: right;">4636</td>
<td style="text-align: left;">FAG</td>
<td style="text-align: right;">0.80</td>
<td style="text-align: right;">35.12</td>
</tr>
<tr class="odd">
<td style="text-align: right;">5108</td>
<td style="text-align: left;">J6S</td>
<td style="text-align: right;">5.05</td>
<td style="text-align: right;">0.70</td>
</tr>
<tr class="even">
<td style="text-align: right;">4640</td>
<td style="text-align: left;">VRG</td>
<td style="text-align: right;">0.31</td>
<td style="text-align: right;">23.72</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<p>A ce stade, on a récupéré une table avec la surface par type de culture pour chaque carreau de la grille.</p>
</section>
<section id="calcul-dindicateurs-par-type-de-culture" class="level2" data-number="3.5">
<h2 data-number="3.5" class="anchored" data-anchor-id="calcul-dindicateurs-par-type-de-culture"><span class="header-section-number">3.5</span> Calcul d’indicateurs par type de culture</h2>
<p>On peut maintenant calculer un écart moyen de cumul de précipitation (d’avril à octobre) par unité de surface pour chaque culture, afin identifier celles qui seront impactées par des baisses de précipitations à horizon proche. Un fichier <code>.csv</code> contenant les intitulés complets des différentes cultures est disponible sur MinIO (bucket <code>"projet-funathon"</code>, objet <code>"2023/sujet2/diffusion/ign/rpg/CULTURE.csv"</code>).</p>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
</div>
<div class="callout-body-container callout-body">
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Récupération des libellés des codes culture</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>culture_mapping <span class="ot">&lt;-</span> <span class="fu">s3read_using</span>(</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">FUN =</span> read.csv,</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">sep =</span> <span class="st">";"</span>,</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">object =</span> <span class="st">"2023/sujet2/diffusion/ign/rpg/CULTURE.csv"</span>,</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">bucket =</span> <span class="st">"projet-funathon"</span>,</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">opts =</span> <span class="fu">list</span>(<span class="st">"region"</span> <span class="ot">=</span> <span class="st">""</span>)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="co"># On aggrège au niveau national par code culture et on calcule un écart</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="co"># moyen du cumul par m2</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>agg_arra_df <span class="ot">&lt;-</span> arra_df <span class="sc">%&gt;%</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(code_cultu) <span class="sc">%&gt;%</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">ecart_volume_precip =</span> <span class="fu">sum</span>(surface <span class="sc">*</span> arra), <span class="at">surface =</span> <span class="fu">sum</span>(surface)) <span class="sc">%&gt;%</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ecart_cumul_moyen =</span> ecart_volume_precip <span class="sc">/</span> surface)</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Récupération des 10 cultures avec une forte perte de précipitation</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>agg_arra_df <span class="sc">%&gt;%</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(culture_mapping, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"code_cultu"</span> <span class="ot">=</span> <span class="st">"Code"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(ecart_cumul_moyen) <span class="sc">%&gt;%</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">10</span>) <span class="sc">%&gt;%</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>()</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 7%">
<col style="width: 13%">
<col style="width: 7%">
<col style="width: 12%">
<col style="width: 58%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">code_cultu</th>
<th style="text-align: right;">ecart_volume_precip</th>
<th style="text-align: right;">surface</th>
<th style="text-align: right;">ecart_cumul_moyen</th>
<th style="text-align: left;">Libellé</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">PVP</td>
<td style="text-align: right;">-13726.4694</td>
<td style="text-align: right;">346.56</td>
<td style="text-align: right;">-39.607772</td>
<td style="text-align: left;">Poivron / Piment</td>
</tr>
<tr class="even">
<td style="text-align: left;">MID</td>
<td style="text-align: right;">-310201.4660</td>
<td style="text-align: right;">26283.67</td>
<td style="text-align: right;">-11.802061</td>
<td style="text-align: left;">Maïs doux</td>
</tr>
<tr class="odd">
<td style="text-align: left;">SGE</td>
<td style="text-align: right;">-24903.3477</td>
<td style="text-align: right;">3327.82</td>
<td style="text-align: right;">-7.483382</td>
<td style="text-align: left;">Sauge</td>
</tr>
<tr class="even">
<td style="text-align: left;">ARA</td>
<td style="text-align: right;">-541.0369</td>
<td style="text-align: right;">76.50</td>
<td style="text-align: right;">-7.072378</td>
<td style="text-align: left;">Arachide</td>
</tr>
<tr class="odd">
<td style="text-align: left;">LAV</td>
<td style="text-align: right;">105054.4076</td>
<td style="text-align: right;">35387.95</td>
<td style="text-align: right;">2.968649</td>
<td style="text-align: left;">Lavande / Lavandin</td>
</tr>
<tr class="even">
<td style="text-align: left;">SPH</td>
<td style="text-align: right;">6608775.8514</td>
<td style="text-align: right;">2041360.68</td>
<td style="text-align: right;">3.237437</td>
<td style="text-align: left;">Surface pastorale - herbe prédominante et ressources fourragères ligneuses présentes</td>
</tr>
<tr class="odd">
<td style="text-align: left;">VAL</td>
<td style="text-align: right;">107.8679</td>
<td style="text-align: right;">31.53</td>
<td style="text-align: right;">3.421120</td>
<td style="text-align: left;">Valériane</td>
</tr>
<tr class="even">
<td style="text-align: left;">PAQ</td>
<td style="text-align: right;">158.4835</td>
<td style="text-align: right;">26.45</td>
<td style="text-align: right;">5.991815</td>
<td style="text-align: left;">Pâquerette</td>
</tr>
<tr class="odd">
<td style="text-align: left;">CRN</td>
<td style="text-align: right;">70.0155</td>
<td style="text-align: right;">10.77</td>
<td style="text-align: right;">6.500975</td>
<td style="text-align: left;">Cornille</td>
</tr>
<tr class="even">
<td style="text-align: left;">NVH</td>
<td style="text-align: right;">180.2147</td>
<td style="text-align: right;">25.00</td>
<td style="text-align: right;">7.208588</td>
<td style="text-align: left;">Navette d’hiver</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<p>On observe que maïs doux est une culture qui va connaître une baisse de cumul de précipitations à horizon proche. Où sont situées les parcelles de maïs doux ? On souhaite dessiner une carte indiquant l’emplacement de ces parcelles. Pour ce faire, faire une requête de la table <code>rpg.parcelles</code> et utiliser <code>ggplot2</code> et sa fonction <code>geom_sf</code> pour tracer la carte. Pour que les parcelles soient visibles, on pourra artificiellement augmenter leur surface grâce à la fonction <a href="https://r-spatial.github.io/sf/reference/geos_unary.html"><code>st_buffer</code></a>.</p>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
</div>
<div class="callout-body-container callout-body">
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Frontières régionales de métropole</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>region_sf <span class="ot">&lt;-</span> <span class="fu">st_read</span>(</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  cnx, <span class="at">query =</span> <span class="st">"SELECT * FROM adminexpress.region"</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>region_sf <span class="ot">&lt;-</span> region_sf <span class="sc">%&gt;%</span> <span class="fu">st_transform</span>(</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"EPSG:2154"</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>region_sf <span class="ot">&lt;-</span> region_sf <span class="sc">%&gt;%</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span>(insee_reg <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"03"</span>, <span class="st">"04"</span>, <span class="st">"06"</span>, <span class="st">"01"</span>, <span class="st">"02"</span>, <span class="st">"01_SBSM"</span>)))</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Parcelles de maïs doux</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>query_mid <span class="ot">&lt;-</span> <span class="st">"</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="st">SELECT id_parcel, geom</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="st">FROM rpg.parcelles</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="st">WHERE code_cultu = 'MID'</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a><span class="st">"</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>cultures_mid <span class="ot">&lt;-</span> <span class="fu">st_read</span>(cnx, <span class="at">query =</span> query_mid)</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> region_sf) <span class="sc">+</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> <span class="fu">st_buffer</span>(cultures_mid, <span class="dv">5000</span>), <span class="at">fill =</span> <span class="st">"#fca8ab"</span>, <span class="at">color =</span> <span class="cn">NA</span>)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="app2_files/figure-html/localisation-mais-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
</div>
</div>
<p>On observe comme attendu beaucoup de parcelles dans le Sud-Ouest où des baisses de précipitations sont attendues à horizon proche.</p>
</section>
<section id="pour-aller-plus-loin" class="level2" data-number="3.6">
<h2 data-number="3.6" class="anchored" data-anchor-id="pour-aller-plus-loin"><span class="header-section-number">3.6</span> Pour aller plus loin</h2>
<p>Pour aller plus loin, plusieurs idées :</p>
<ul>
<li>Calculer des écarts en pourcentage par rapport au niveau sur la période de référence pour avoir une idée plus parlante de la diminution ou de l’augmentation du cumul de précipitations;</li>
<li>Regarder plutôt les prévisions climatiques à long terme, en utilisant la table <code>drias.previsions_hl</code> qui concerne la période 2071-2100;</li>
<li>S’intéresser aux autres indicateurs qui existent dans les données DRIAS;</li>
</ul>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copié");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copié");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./app1.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Première manipulation du RPG</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./physio_era5.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Évolution de la date théorique de récolte</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Code source</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb8" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Cultures et prévisions climatiques"</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="an">pagetitle:</span><span class="co"> "Prévisions"</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="an">keywords:</span><span class="co"> ["RPG", "prévisions", "cultures"]</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="an">number-sections:</span><span class="co"> true</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="an">knitr:</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="co">  opts_chunk: </span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="co">    dev: "ragg_png"</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="co">    out.width: 100%</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>Le changement climatique aura des changements importants sur les cultures en France, en particulier à cause de la diminution des précipitations dans certaines régions au cours des années à venir. Dans cette application, on souhaite identifier les cultures avec le niveau de risque le plus élevé.</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a><span class="fu">## Données</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Le <span class="co">[</span><span class="ot">RPG</span><span class="co">](https://geoservices.ign.fr/rpg)</span> recense les parcelles déclarées à la PAC par les agriculteurs, leurs informations graphiques et leur culture principale. Ces données sont mises à disposition dans une base de données PostgreSQL.</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Le projet <span class="co">[</span><span class="ot">Drias</span><span class="co">](https://www.drias-climat.fr/)</span> a pour vocation de mettre à disposition des projections climatiques réalisées dans les laboratoires français de modélisation du climat (IPSL, CERFACS, CNRM). En particulier, nous disposons de projections locales du modèle CNRM-CM5 / ALADIN63 / correction ADAMONT. Ces données sont aussi mises à disposition sur PostgreSQL. </span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a><span class="fu">## Visualisations</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>On initialise une nouvelle fois la connexion à PostgreSQL comme expliqué à la fin de l'application 0.</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: setup</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: false</span></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RPostgres)</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(aws.s3)</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(raster)</span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(janitor)</span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr)</span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Pour avoir les noms de dates en français</span></span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a><span class="fu">invisible</span>(<span class="fu">Sys.setlocale</span>(<span class="st">"LC_ALL"</span>, <span class="st">"fr_FR.UTF-8"</span>))</span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">knitr.kable.NA =</span> <span class="st">""</span>)</span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>cnx <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(<span class="fu">Postgres</span>(),</span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>                 <span class="at">user =</span> <span class="fu">Sys.getenv</span>(<span class="st">"USER_POSTGRESQL"</span>),</span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>                 <span class="at">password =</span> <span class="fu">Sys.getenv</span>(<span class="st">"PASS_POSTGRESQL"</span>),</span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>                 <span class="at">host =</span> <span class="fu">Sys.getenv</span>(<span class="st">"HOST_POSTGRESQL"</span>),</span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>                 <span class="at">dbname =</span> <span class="st">"defaultdb"</span>,</span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a>                 <span class="at">port =</span> <span class="dv">5432</span>,</span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>                 <span class="at">check_interrupts =</span> <span class="cn">TRUE</span>)</span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a>On souhaite tout d'abord visualiser les données DRIAS. On peut passer par les données sauvegardées au format raster qui sont stockées dans l'espace de stockage du SSP Cloud. Ces données correspondent à des prévisions à horizon proche (2021-2050) dans un scénario sans réduction des gaz à effet de serre, la période de référence étant 1976-2005. Le code ci-dessous permet de récupérer les données.</span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: get-drias-raster</span></span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: false</span></span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a>drias_raster <span class="ot">&lt;-</span> <span class="fu">s3read_using</span>(</span>
<span id="cb8-62"><a href="#cb8-62" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(f) <span class="fu">readAll</span>(<span class="fu">brick</span>(f)),</span>
<span id="cb8-63"><a href="#cb8-63" aria-hidden="true" tabindex="-1"></a>  <span class="at">object =</span> <span class="st">"2023/sujet2/diffusion/resultats/drias.tif"</span>,</span>
<span id="cb8-64"><a href="#cb8-64" aria-hidden="true" tabindex="-1"></a>  <span class="at">bucket =</span> <span class="st">"projet-funathon"</span>,</span>
<span id="cb8-65"><a href="#cb8-65" aria-hidden="true" tabindex="-1"></a>  <span class="at">opts =</span> <span class="fu">list</span>(<span class="st">"region"</span> <span class="ot">=</span> <span class="st">""</span>))</span>
<span id="cb8-66"><a href="#cb8-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-67"><a href="#cb8-67" aria-hidden="true" tabindex="-1"></a>drias_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(drias_raster, <span class="at">xy =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> tidyr<span class="sc">::</span><span class="fu">drop_na</span>()</span>
<span id="cb8-68"><a href="#cb8-68" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(drias_df) <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb8-69"><a href="#cb8-69" aria-hidden="true" tabindex="-1"></a>  <span class="st">"x"</span>,</span>
<span id="cb8-70"><a href="#cb8-70" aria-hidden="true" tabindex="-1"></a>  <span class="st">"y"</span>,</span>
<span id="cb8-71"><a href="#cb8-71" aria-hidden="true" tabindex="-1"></a>  <span class="st">"NORRRA"</span>,</span>
<span id="cb8-72"><a href="#cb8-72" aria-hidden="true" tabindex="-1"></a>  <span class="st">"NORSTM6"</span>,</span>
<span id="cb8-73"><a href="#cb8-73" aria-hidden="true" tabindex="-1"></a>  <span class="st">"NORSTM0"</span>,</span>
<span id="cb8-74"><a href="#cb8-74" aria-hidden="true" tabindex="-1"></a>  <span class="st">"NORSDA"</span>,</span>
<span id="cb8-75"><a href="#cb8-75" aria-hidden="true" tabindex="-1"></a>  <span class="st">"NORDATEVEG"</span>,</span>
<span id="cb8-76"><a href="#cb8-76" aria-hidden="true" tabindex="-1"></a>  <span class="st">"NORDATEDG"</span>,</span>
<span id="cb8-77"><a href="#cb8-77" aria-hidden="true" tabindex="-1"></a>  <span class="st">"NORDATEPG"</span>,</span>
<span id="cb8-78"><a href="#cb8-78" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ARRA"</span>,</span>
<span id="cb8-79"><a href="#cb8-79" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ASTM6"</span>,</span>
<span id="cb8-80"><a href="#cb8-80" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ASTM0"</span>,</span>
<span id="cb8-81"><a href="#cb8-81" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ASDA"</span>,</span>
<span id="cb8-82"><a href="#cb8-82" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ADATEVEG"</span>,</span>
<span id="cb8-83"><a href="#cb8-83" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ADATEDG"</span>,</span>
<span id="cb8-84"><a href="#cb8-84" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ADATEPG"</span>,</span>
<span id="cb8-85"><a href="#cb8-85" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ALTI"</span></span>
<span id="cb8-86"><a href="#cb8-86" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-87"><a href="#cb8-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-88"><a href="#cb8-88" aria-hidden="true" tabindex="-1"></a>drias_df <span class="sc">%&gt;%</span> <span class="fu">head</span>(<span class="dv">10</span>) <span class="sc">%&gt;%</span> <span class="fu">kable</span>()</span>
<span id="cb8-89"><a href="#cb8-89" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-90"><a href="#cb8-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-91"><a href="#cb8-91" aria-hidden="true" tabindex="-1"></a>Les variables disponibles dans les données DRIAS sont systématiquement calculées sur la période 2021-2050 (préfixe NOR), et en écart avec la période de référence (préfixe A) :</span>
<span id="cb8-92"><a href="#cb8-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-93"><a href="#cb8-93" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>RRA : cumul de précipitations d'avril à octobre (mm)</span>
<span id="cb8-94"><a href="#cb8-94" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>STM6 : somme de température base 6°C d'avril à octobre (°C)</span>
<span id="cb8-95"><a href="#cb8-95" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>STM0 : somme de température base 0°C d'octobre (année-1) à juillet (année) (°C)</span>
<span id="cb8-96"><a href="#cb8-96" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>SDA : nombre de jours d'été d'avril à juin (jour(s))</span>
<span id="cb8-97"><a href="#cb8-97" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>DATEVEG : date de reprise de végétation en jour julien (date)</span>
<span id="cb8-98"><a href="#cb8-98" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>DATEDG : Date de dernière gelée avec 1er juillet comme référence (date)</span>
<span id="cb8-99"><a href="#cb8-99" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>DATEPG : Date de première gelée avec 1er juillet comme référence (date)</span>
<span id="cb8-100"><a href="#cb8-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-101"><a href="#cb8-101" aria-hidden="true" tabindex="-1"></a>On souhaite visualiser la variable ARRA, qui correspond à la huitième couche du raster et correspond à l'écart de cumul de précipitations d'avril à octobre en mm. Pour faire cela, on pourra récupérer spécifiquement la couche désirée lors de l'utilisation de la fonction <span class="co">[</span><span class="ot">`raster::raster`</span><span class="co">](https://www.rdocumentation.org/packages/raster/versions/3.6-20/topics/raster)</span>. Pour la visualisation, on pourra utiliser <span class="co">[</span><span class="ot">`raster::plot`</span><span class="co">](https://www.rdocumentation.org/packages/raster/versions/3.6-20/topics/plot)</span>.</span>
<span id="cb8-102"><a href="#cb8-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-103"><a href="#cb8-103" aria-hidden="true" tabindex="-1"></a>::: {.callout-note icon=false}</span>
<span id="cb8-104"><a href="#cb8-104" aria-hidden="true" tabindex="-1"></a><span class="fu">## Solution</span></span>
<span id="cb8-105"><a href="#cb8-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-108"><a href="#cb8-108" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb8-109"><a href="#cb8-109" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: drias_vis_raster</span></span>
<span id="cb8-110"><a href="#cb8-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-111"><a href="#cb8-111" aria-hidden="true" tabindex="-1"></a><span class="co"># Bande ARRA</span></span>
<span id="cb8-112"><a href="#cb8-112" aria-hidden="true" tabindex="-1"></a>drias_raster_arra <span class="ot">&lt;-</span> <span class="fu">s3read_using</span>(</span>
<span id="cb8-113"><a href="#cb8-113" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(f) <span class="fu">readAll</span>(<span class="fu">raster</span>(f, <span class="at">band =</span> <span class="dv">8</span>)),</span>
<span id="cb8-114"><a href="#cb8-114" aria-hidden="true" tabindex="-1"></a>  <span class="at">object =</span> <span class="st">"2023/sujet2/diffusion/resultats/drias.tif"</span>,</span>
<span id="cb8-115"><a href="#cb8-115" aria-hidden="true" tabindex="-1"></a>  <span class="at">bucket =</span> <span class="st">"projet-funathon"</span>,</span>
<span id="cb8-116"><a href="#cb8-116" aria-hidden="true" tabindex="-1"></a>  <span class="at">opts =</span> <span class="fu">list</span>(<span class="st">"region"</span> <span class="ot">=</span> <span class="st">""</span>))</span>
<span id="cb8-117"><a href="#cb8-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-118"><a href="#cb8-118" aria-hidden="true" tabindex="-1"></a><span class="co"># Avec palette custom</span></span>
<span id="cb8-119"><a href="#cb8-119" aria-hidden="true" tabindex="-1"></a>palette <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"#1457ff"</span>, <span class="st">"#3c9aff"</span>, <span class="st">"#6dc4ff"</span>, <span class="st">"#a8e1ff"</span>, <span class="st">"#dff1fb"</span>, <span class="st">"#f8e9eb"</span>, <span class="st">"#fca8ab"</span>, <span class="st">"#f9575d"</span>, <span class="st">"#f2060b"</span>, <span class="st">"#a20102"</span>)</span>
<span id="cb8-120"><a href="#cb8-120" aria-hidden="true" tabindex="-1"></a>breaks <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">200</span>, <span class="sc">-</span><span class="dv">160</span>, <span class="sc">-</span><span class="dv">120</span>, <span class="sc">-</span><span class="dv">80</span>, <span class="sc">-</span><span class="dv">40</span>, <span class="sc">-</span><span class="dv">0</span>, <span class="dv">40</span>, <span class="dv">80</span>, <span class="dv">120</span>, <span class="dv">160</span>, <span class="dv">200</span>)</span>
<span id="cb8-121"><a href="#cb8-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-122"><a href="#cb8-122" aria-hidden="true" tabindex="-1"></a>raster<span class="sc">::</span><span class="fu">plot</span>(<span class="at">x =</span> drias_raster_arra,</span>
<span id="cb8-123"><a href="#cb8-123" aria-hidden="true" tabindex="-1"></a>             <span class="at">col =</span> <span class="fu">rev</span>(palette),</span>
<span id="cb8-124"><a href="#cb8-124" aria-hidden="true" tabindex="-1"></a>             <span class="at">breaks =</span> breaks,</span>
<span id="cb8-125"><a href="#cb8-125" aria-hidden="true" tabindex="-1"></a>             <span class="at">main =</span> <span class="st">"Ecart de cumul de précipitations d'avril à octobre (mm)</span><span class="sc">\n</span><span class="st">entre 2021-2050 et 1976-2005"</span>)</span>
<span id="cb8-126"><a href="#cb8-126" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-127"><a href="#cb8-127" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb8-128"><a href="#cb8-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-129"><a href="#cb8-129" aria-hidden="true" tabindex="-1"></a>Sur la période 2021-2050, les précipitations vont augmenter presque partout, sauf dans le Sud-Ouest de la France.</span>
<span id="cb8-130"><a href="#cb8-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-131"><a href="#cb8-131" aria-hidden="true" tabindex="-1"></a><span class="fu">## Requêtes PostgreSQL </span></span>
<span id="cb8-132"><a href="#cb8-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-133"><a href="#cb8-133" aria-hidden="true" tabindex="-1"></a>Les données DRIAS sont également stockées dans une base PostgreSQL qu'il est possible de requêter. La table <span class="in">`drias.previsions`</span> contient une grille équivalente aux données raster précédemment utilisées. On souhaite obtenir la même visualisation que celle obtenue précédemment en requêtant la base de données. Pour ce faire, utiliser la fonction <span class="in">`sf::st_read`</span> avec une requête sur la table <span class="in">`drias.previsions`</span>. Pour la création de la carte, on peut utiliser le package <span class="in">`ggplot2`</span> et sa fonction <span class="co">[</span><span class="ot">`geom_sf`</span><span class="co">](https://ggplot2.tidyverse.org/reference/ggsf.html)</span>.</span>
<span id="cb8-134"><a href="#cb8-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-135"><a href="#cb8-135" aria-hidden="true" tabindex="-1"></a>::: {.callout-note icon=false}</span>
<span id="cb8-136"><a href="#cb8-136" aria-hidden="true" tabindex="-1"></a><span class="fu">## Solution</span></span>
<span id="cb8-137"><a href="#cb8-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-140"><a href="#cb8-140" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb8-141"><a href="#cb8-141" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: drias_vis_postgresql</span></span>
<span id="cb8-142"><a href="#cb8-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-143"><a href="#cb8-143" aria-hidden="true" tabindex="-1"></a>query <span class="ot">&lt;-</span> <span class="st">"</span></span>
<span id="cb8-144"><a href="#cb8-144" aria-hidden="true" tabindex="-1"></a><span class="st">SELECT *</span></span>
<span id="cb8-145"><a href="#cb8-145" aria-hidden="true" tabindex="-1"></a><span class="st">FROM drias.previsions</span></span>
<span id="cb8-146"><a href="#cb8-146" aria-hidden="true" tabindex="-1"></a><span class="st">"</span></span>
<span id="cb8-147"><a href="#cb8-147" aria-hidden="true" tabindex="-1"></a>drias_sf <span class="ot">&lt;-</span> <span class="fu">st_read</span>(cnx, <span class="at">query =</span> query)</span>
<span id="cb8-148"><a href="#cb8-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-149"><a href="#cb8-149" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb8-150"><a href="#cb8-150" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> drias_sf, <span class="fu">aes</span>(<span class="at">fill =</span> arra), <span class="at">color =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb8-151"><a href="#cb8-151" aria-hidden="true" tabindex="-1"></a>  <span class="fu">binned_scale</span>(<span class="at">aesthetics =</span> <span class="st">"fill"</span>, <span class="at">scale_name =</span> <span class="st">"custom"</span>, </span>
<span id="cb8-152"><a href="#cb8-152" aria-hidden="true" tabindex="-1"></a>               <span class="at">palette =</span> ggplot2<span class="sc">:::</span><span class="fu">binned_pal</span>(scales<span class="sc">::</span><span class="fu">manual_pal</span>(<span class="at">values =</span> <span class="fu">rev</span>(palette)[<span class="sc">-</span><span class="dv">1</span>])),</span>
<span id="cb8-153"><a href="#cb8-153" aria-hidden="true" tabindex="-1"></a>               <span class="at">guide =</span> <span class="st">"bins"</span>,</span>
<span id="cb8-154"><a href="#cb8-154" aria-hidden="true" tabindex="-1"></a>               <span class="at">breaks =</span> breaks)</span>
<span id="cb8-155"><a href="#cb8-155" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-156"><a href="#cb8-156" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb8-157"><a href="#cb8-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-158"><a href="#cb8-158" aria-hidden="true" tabindex="-1"></a><span class="fu">## Appariement spatial entre données DRIAS et RPG</span></span>
<span id="cb8-159"><a href="#cb8-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-160"><a href="#cb8-160" aria-hidden="true" tabindex="-1"></a>On aimerait associer chaque culture à une évolution en terme de cumul de précipitation. Pour ceci il faut tout d'abord récupérer pour chaque culture la surface des parcelles existantes dans chaque carreau de la grille DRIAS. Pour ceci on peut procéder à un appariement spatial des tables <span class="in">`drias.previsions`</span> et <span class="in">`rpg.parcelles`</span> de la base de données. On pourra s'aider de <span class="co">[</span><span class="ot">cette page</span><span class="co">](https://postgis.net/workshops/postgis-intro/joins.html)</span> de documentation, et utiliser <span class="co">[</span><span class="ot">`ST_Intersects`</span><span class="co">](https://postgis.net/docs/ST_Intersects.html)</span>.</span>
<span id="cb8-161"><a href="#cb8-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-162"><a href="#cb8-162" aria-hidden="true" tabindex="-1"></a>::: {.callout-note icon=false}</span>
<span id="cb8-163"><a href="#cb8-163" aria-hidden="true" tabindex="-1"></a><span class="fu">## Solution</span></span>
<span id="cb8-164"><a href="#cb8-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-167"><a href="#cb8-167" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb8-168"><a href="#cb8-168" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: spatial-join</span></span>
<span id="cb8-169"><a href="#cb8-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-170"><a href="#cb8-170" aria-hidden="true" tabindex="-1"></a><span class="co"># On récupère par carreau de la grille DRIAS la surface pour chaque type de culture</span></span>
<span id="cb8-171"><a href="#cb8-171" aria-hidden="true" tabindex="-1"></a>query <span class="ot">&lt;-</span> <span class="st">"</span></span>
<span id="cb8-172"><a href="#cb8-172" aria-hidden="true" tabindex="-1"></a><span class="st">SELECT B.point, code_cultu, Sum(surf_parc) AS surface, B.arra</span></span>
<span id="cb8-173"><a href="#cb8-173" aria-hidden="true" tabindex="-1"></a><span class="st">FROM rpg.parcelles AS A</span></span>
<span id="cb8-174"><a href="#cb8-174" aria-hidden="true" tabindex="-1"></a><span class="st">JOIN drias.previsions AS B</span></span>
<span id="cb8-175"><a href="#cb8-175" aria-hidden="true" tabindex="-1"></a><span class="st">ON ST_Intersects(A.geom , B.geometry)</span></span>
<span id="cb8-176"><a href="#cb8-176" aria-hidden="true" tabindex="-1"></a><span class="st">GROUP BY B.point, B.arra, code_cultu</span></span>
<span id="cb8-177"><a href="#cb8-177" aria-hidden="true" tabindex="-1"></a><span class="st">"</span></span>
<span id="cb8-178"><a href="#cb8-178" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">dbSendQuery</span>(cnx, query)</span>
<span id="cb8-179"><a href="#cb8-179" aria-hidden="true" tabindex="-1"></a>arra_df <span class="ot">&lt;-</span> <span class="fu">dbFetch</span>(res)</span>
<span id="cb8-180"><a href="#cb8-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-181"><a href="#cb8-181" aria-hidden="true" tabindex="-1"></a>arra_df <span class="sc">%&gt;%</span> <span class="fu">head</span>(<span class="dv">10</span>) <span class="sc">%&gt;%</span> <span class="fu">kable</span>()</span>
<span id="cb8-182"><a href="#cb8-182" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-183"><a href="#cb8-183" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb8-184"><a href="#cb8-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-185"><a href="#cb8-185" aria-hidden="true" tabindex="-1"></a>A ce stade, on a récupéré une table avec la surface par type de culture pour chaque carreau de la grille.</span>
<span id="cb8-186"><a href="#cb8-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-187"><a href="#cb8-187" aria-hidden="true" tabindex="-1"></a><span class="fu">## Calcul d'indicateurs par type de culture</span></span>
<span id="cb8-188"><a href="#cb8-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-189"><a href="#cb8-189" aria-hidden="true" tabindex="-1"></a>On peut maintenant calculer un écart moyen de cumul de précipitation (d'avril à octobre) par unité de surface pour chaque culture, afin identifier celles qui seront impactées par des baisses de précipitations à horizon proche. Un fichier <span class="in">`.csv`</span> contenant les intitulés complets des différentes cultures est disponible sur MinIO (bucket <span class="in">`"projet-funathon"`</span>, objet <span class="in">`"2023/sujet2/diffusion/ign/rpg/CULTURE.csv"`</span>).</span>
<span id="cb8-190"><a href="#cb8-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-191"><a href="#cb8-191" aria-hidden="true" tabindex="-1"></a>::: {.callout-note icon=false}</span>
<span id="cb8-192"><a href="#cb8-192" aria-hidden="true" tabindex="-1"></a><span class="fu">## Solution</span></span>
<span id="cb8-193"><a href="#cb8-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-196"><a href="#cb8-196" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb8-197"><a href="#cb8-197" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: aggregation-culture</span></span>
<span id="cb8-198"><a href="#cb8-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-199"><a href="#cb8-199" aria-hidden="true" tabindex="-1"></a><span class="co"># Récupération des libellés des codes culture</span></span>
<span id="cb8-200"><a href="#cb8-200" aria-hidden="true" tabindex="-1"></a>culture_mapping <span class="ot">&lt;-</span> <span class="fu">s3read_using</span>(</span>
<span id="cb8-201"><a href="#cb8-201" aria-hidden="true" tabindex="-1"></a>  <span class="at">FUN =</span> read.csv,</span>
<span id="cb8-202"><a href="#cb8-202" aria-hidden="true" tabindex="-1"></a>  <span class="at">sep =</span> <span class="st">";"</span>,</span>
<span id="cb8-203"><a href="#cb8-203" aria-hidden="true" tabindex="-1"></a>  <span class="at">object =</span> <span class="st">"2023/sujet2/diffusion/ign/rpg/CULTURE.csv"</span>,</span>
<span id="cb8-204"><a href="#cb8-204" aria-hidden="true" tabindex="-1"></a>  <span class="at">bucket =</span> <span class="st">"projet-funathon"</span>,</span>
<span id="cb8-205"><a href="#cb8-205" aria-hidden="true" tabindex="-1"></a>  <span class="at">opts =</span> <span class="fu">list</span>(<span class="st">"region"</span> <span class="ot">=</span> <span class="st">""</span>)</span>
<span id="cb8-206"><a href="#cb8-206" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-207"><a href="#cb8-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-208"><a href="#cb8-208" aria-hidden="true" tabindex="-1"></a><span class="co"># On aggrège au niveau national par code culture et on calcule un écart</span></span>
<span id="cb8-209"><a href="#cb8-209" aria-hidden="true" tabindex="-1"></a><span class="co"># moyen du cumul par m2</span></span>
<span id="cb8-210"><a href="#cb8-210" aria-hidden="true" tabindex="-1"></a>agg_arra_df <span class="ot">&lt;-</span> arra_df <span class="sc">%&gt;%</span></span>
<span id="cb8-211"><a href="#cb8-211" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(code_cultu) <span class="sc">%&gt;%</span></span>
<span id="cb8-212"><a href="#cb8-212" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">ecart_volume_precip =</span> <span class="fu">sum</span>(surface <span class="sc">*</span> arra), <span class="at">surface =</span> <span class="fu">sum</span>(surface)) <span class="sc">%&gt;%</span></span>
<span id="cb8-213"><a href="#cb8-213" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ecart_cumul_moyen =</span> ecart_volume_precip <span class="sc">/</span> surface)</span>
<span id="cb8-214"><a href="#cb8-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-215"><a href="#cb8-215" aria-hidden="true" tabindex="-1"></a><span class="co"># Récupération des 10 cultures avec une forte perte de précipitation</span></span>
<span id="cb8-216"><a href="#cb8-216" aria-hidden="true" tabindex="-1"></a>agg_arra_df <span class="sc">%&gt;%</span></span>
<span id="cb8-217"><a href="#cb8-217" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(culture_mapping, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"code_cultu"</span> <span class="ot">=</span> <span class="st">"Code"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb8-218"><a href="#cb8-218" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(ecart_cumul_moyen) <span class="sc">%&gt;%</span></span>
<span id="cb8-219"><a href="#cb8-219" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">10</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-220"><a href="#cb8-220" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>()</span>
<span id="cb8-221"><a href="#cb8-221" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-222"><a href="#cb8-222" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb8-223"><a href="#cb8-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-224"><a href="#cb8-224" aria-hidden="true" tabindex="-1"></a>On observe que maïs doux est une culture qui va connaître une baisse de cumul de précipitations à horizon proche. Où sont situées les parcelles de maïs doux ? On souhaite dessiner une carte indiquant l'emplacement de ces parcelles. Pour ce faire, faire une requête de la table <span class="in">`rpg.parcelles`</span> et utiliser <span class="in">`ggplot2`</span> et sa fonction <span class="in">`geom_sf`</span> pour tracer la carte. Pour que les parcelles soient visibles, on pourra artificiellement augmenter leur surface grâce à la fonction <span class="co">[</span><span class="ot">`st_buffer`</span><span class="co">](https://r-spatial.github.io/sf/reference/geos_unary.html)</span>.</span>
<span id="cb8-225"><a href="#cb8-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-226"><a href="#cb8-226" aria-hidden="true" tabindex="-1"></a>::: {.callout-note icon=false}</span>
<span id="cb8-227"><a href="#cb8-227" aria-hidden="true" tabindex="-1"></a><span class="fu">## Solution</span></span>
<span id="cb8-228"><a href="#cb8-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-231"><a href="#cb8-231" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb8-232"><a href="#cb8-232" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: localisation-mais</span></span>
<span id="cb8-233"><a href="#cb8-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-234"><a href="#cb8-234" aria-hidden="true" tabindex="-1"></a><span class="co"># Frontières régionales de métropole</span></span>
<span id="cb8-235"><a href="#cb8-235" aria-hidden="true" tabindex="-1"></a>region_sf <span class="ot">&lt;-</span> <span class="fu">st_read</span>(</span>
<span id="cb8-236"><a href="#cb8-236" aria-hidden="true" tabindex="-1"></a>  cnx, <span class="at">query =</span> <span class="st">"SELECT * FROM adminexpress.region"</span></span>
<span id="cb8-237"><a href="#cb8-237" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-238"><a href="#cb8-238" aria-hidden="true" tabindex="-1"></a>region_sf <span class="ot">&lt;-</span> region_sf <span class="sc">%&gt;%</span> <span class="fu">st_transform</span>(</span>
<span id="cb8-239"><a href="#cb8-239" aria-hidden="true" tabindex="-1"></a>  <span class="st">"EPSG:2154"</span></span>
<span id="cb8-240"><a href="#cb8-240" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-241"><a href="#cb8-241" aria-hidden="true" tabindex="-1"></a>region_sf <span class="ot">&lt;-</span> region_sf <span class="sc">%&gt;%</span></span>
<span id="cb8-242"><a href="#cb8-242" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span>(insee_reg <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"03"</span>, <span class="st">"04"</span>, <span class="st">"06"</span>, <span class="st">"01"</span>, <span class="st">"02"</span>, <span class="st">"01_SBSM"</span>)))</span>
<span id="cb8-243"><a href="#cb8-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-244"><a href="#cb8-244" aria-hidden="true" tabindex="-1"></a><span class="co"># Parcelles de maïs doux</span></span>
<span id="cb8-245"><a href="#cb8-245" aria-hidden="true" tabindex="-1"></a>query_mid <span class="ot">&lt;-</span> <span class="st">"</span></span>
<span id="cb8-246"><a href="#cb8-246" aria-hidden="true" tabindex="-1"></a><span class="st">SELECT id_parcel, geom</span></span>
<span id="cb8-247"><a href="#cb8-247" aria-hidden="true" tabindex="-1"></a><span class="st">FROM rpg.parcelles</span></span>
<span id="cb8-248"><a href="#cb8-248" aria-hidden="true" tabindex="-1"></a><span class="st">WHERE code_cultu = 'MID'</span></span>
<span id="cb8-249"><a href="#cb8-249" aria-hidden="true" tabindex="-1"></a><span class="st">"</span></span>
<span id="cb8-250"><a href="#cb8-250" aria-hidden="true" tabindex="-1"></a>cultures_mid <span class="ot">&lt;-</span> <span class="fu">st_read</span>(cnx, <span class="at">query =</span> query_mid)</span>
<span id="cb8-251"><a href="#cb8-251" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb8-252"><a href="#cb8-252" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> region_sf) <span class="sc">+</span></span>
<span id="cb8-253"><a href="#cb8-253" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> <span class="fu">st_buffer</span>(cultures_mid, <span class="dv">5000</span>), <span class="at">fill =</span> <span class="st">"#fca8ab"</span>, <span class="at">color =</span> <span class="cn">NA</span>)</span>
<span id="cb8-254"><a href="#cb8-254" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-255"><a href="#cb8-255" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb8-256"><a href="#cb8-256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-257"><a href="#cb8-257" aria-hidden="true" tabindex="-1"></a>On observe comme attendu beaucoup de parcelles dans le Sud-Ouest où des baisses de précipitations sont attendues à horizon proche.</span>
<span id="cb8-258"><a href="#cb8-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-259"><a href="#cb8-259" aria-hidden="true" tabindex="-1"></a><span class="fu">## Pour aller plus loin</span></span>
<span id="cb8-260"><a href="#cb8-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-261"><a href="#cb8-261" aria-hidden="true" tabindex="-1"></a>Pour aller plus loin, plusieurs idées :</span>
<span id="cb8-262"><a href="#cb8-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-263"><a href="#cb8-263" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Calculer des écarts en pourcentage par rapport au niveau sur la période de référence pour avoir une idée plus parlante de la diminution ou de l'augmentation du cumul de précipitations;</span>
<span id="cb8-264"><a href="#cb8-264" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Regarder plutôt les prévisions climatiques à long terme, en utilisant la table <span class="in">`drias.previsions_hl`</span> qui concerne la période 2071-2100;</span>
<span id="cb8-265"><a href="#cb8-265" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>S'intéresser aux autres indicateurs qui existent dans les données DRIAS;</span>
</code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



<script src="site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>